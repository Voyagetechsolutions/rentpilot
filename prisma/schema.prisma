// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========================
// Core Models
// ========================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  role          String    @default("LANDLORD") // LANDLORD, TENANT, ADMIN
  name          String?
  phone         String?
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  properties    Property[]
  tenantProfile Tenant?
  documents     Document[] @relation("UploadedBy")
  settings      UserSettings?
}

model UserSettings {
  id                        String   @id @default(cuid())
  userId                    String   @unique
  user                      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Profile
  firstName                 String?
  lastName                  String?
  
  // Notification Preferences
  notifyPaymentReceived     Boolean  @default(true)
  notifyRentOverdue         Boolean  @default(true)
  notifyMaintenanceRequest  Boolean  @default(true)
  notifyLeaseExpiring       Boolean  @default(true)
  
  // Organization
  organizationName          String   @default("My Properties")
  currency                  String   @default("ZAR")
  timezone                  String   @default("Africa/Johannesburg")
  
  // Bank Account (for direct payouts)
  bankName                  String?
  bankCode                  String?  // Paystack bank code
  accountNumber             String?
  accountName               String?  // Verified account name from Paystack
  
  // Paystack Subaccount (for split payments)
  paystackSubaccountCode    String?  @unique
  paystackSubaccountId      String?
  
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

model Property {
  id          String   @id @default(cuid())
  name        String
  address     String
  city        String
  country     String
  landlordId  String
  landlord    User     @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  units       Unit[]
  documents   Document[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Unit {
  id          String     @id @default(cuid())
  unitNumber  String
  propertyId  String
  property    Property   @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  bedrooms    Int        @default(1)
  bathrooms   Int        @default(1)
  rentAmount  Float
  status      String     @default("VACANT") // VACANT, OCCUPIED
  leases      Lease[]
  maintenance MaintenanceRequest[]
  documents   Document[]
  invitations TenantInvitation[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Tenant {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fullName        String
  phone           String
  idNumber        String?
  leases          Lease[]
  payments        Payment[]
  maintenance     MaintenanceRequest[]
  onlinePayments  OnlinePayment[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model TenantInvitation {
  id          String   @id @default(cuid())
  email       String
  fullName    String
  phone       String?
  unitId      String
  unit        Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  landlordId  String
  token       String   @unique @default(cuid())
  status      String   @default("PENDING") // PENDING, ACCEPTED, EXPIRED, CANCELLED
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Lease {
  id             String          @id @default(cuid())
  tenantId       String
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  unitId         String
  unit           Unit            @relation(fields: [unitId], references: [id], onDelete: Cascade)
  rentAmount     Float
  deposit        Float
  startDate      DateTime
  endDate        DateTime
  dueDay         Int             @default(1)
  status         String          @default("ACTIVE") // ACTIVE, ENDED
  rentCharges    RentCharge[]
  payments       Payment[]
  documents      Document[]
  onlinePayments OnlinePayment[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model RentCharge {
  id          String     @id @default(cuid())
  leaseId     String
  lease       Lease      @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  month       String     // Format: "2026-01"
  amountDue   Float
  amountPaid  Float      @default(0)
  status      String     @default("UNPAID") // PAID, PARTIAL, UNPAID, OVERDUE
  dueDate     DateTime
  allocations PaymentAllocation[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Payment {
  id          String              @id @default(cuid())
  tenantId    String
  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  leaseId     String
  lease       Lease               @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  amount      Float
  method      String              // CASH, BANK_TRANSFER, CARD, OTHER
  datePaid    DateTime
  reference   String?
  proofUrl    String?
  allocations PaymentAllocation[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
}

model PaymentAllocation {
  id           String     @id @default(cuid())
  paymentId    String
  payment      Payment    @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  rentChargeId String
  rentCharge   RentCharge @relation(fields: [rentChargeId], references: [id], onDelete: Cascade)
  amount       Float
  createdAt    DateTime   @default(now())
}

model MaintenanceRequest {
  id          String   @id @default(cuid())
  unitId      String
  unit        Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  title       String
  description String
  category    String   // PLUMBING, ELECTRICAL, HVAC, APPLIANCE, STRUCTURAL, OTHER
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  status      String   @default("SUBMITTED") // SUBMITTED, IN_REVIEW, APPROVED, IN_PROGRESS, COMPLETED, REJECTED
  attachments String   @default("[]") // JSON array of URLs
  comments    Comment[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Comment {
  id                   String             @id @default(cuid())
  maintenanceRequestId String
  maintenanceRequest   MaintenanceRequest @relation(fields: [maintenanceRequestId], references: [id], onDelete: Cascade)
  authorId             String
  content              String
  createdAt            DateTime           @default(now())
}

model Document {
  id          String    @id @default(cuid())
  filename    String
  fileUrl     String
  docType     String    // LEASE_AGREEMENT, ID_PROOF, INSPECTION, RECEIPT, NOTICE, OTHER
  propertyId  String?
  property    Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  unitId      String?
  unit        Unit?     @relation(fields: [unitId], references: [id], onDelete: SetNull)
  leaseId     String?
  lease       Lease?    @relation(fields: [leaseId], references: [id], onDelete: SetNull)
  uploadedById String
  uploadedBy  User      @relation("UploadedBy", fields: [uploadedById], references: [id])
  createdAt   DateTime  @default(now())
}

model OnlinePayment {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  leaseId         String
  lease           Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  amount          Float
  reference       String   @unique // Paystack reference
  accessCode      String?  // Paystack access code for inline checkout
  authorizationUrl String? // Redirect URL
  status          String   @default("PENDING") // PENDING, SUCCESS, FAILED
  gatewayResponse String?  // JSON response from Paystack
  paidAt          DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String   // USER_SIGNUP, USER_LOGIN, PAYMENT_RECEIVED, PROPERTY_CREATED, etc.
  entityType  String?  // User, Property, Payment, etc.
  entityId    String?
  details     String?  // JSON additional info
  ipAddress   String?
  createdAt   DateTime @default(now())
}
