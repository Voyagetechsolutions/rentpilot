// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========================
// Core Models
// ========================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  role          String    @default("LANDLORD") // LANDLORD, TENANT, ADMIN
  name          String?
  phone         String?
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  properties    Property[]
  tenantProfile Tenant?
  documents     Document[] @relation("UploadedBy")
  settings      UserSettings?
}

model UserSettings {
  id                        String   @id @default(cuid())
  userId                    String   @unique
  user                      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Profile
  firstName                 String?
  lastName                  String?
  
  // Notification Preferences
  notifyPaymentReceived     Boolean  @default(true)
  notifyRentOverdue         Boolean  @default(true)
  notifyMaintenanceRequest  Boolean  @default(true)
  notifyLeaseExpiring       Boolean  @default(true)
  
  // Organization
  organizationName          String   @default("My Properties")
  currency                  String   @default("ZAR")
  timezone                  String   @default("Africa/Johannesburg")
  
  // Bank Account (for direct payouts)
  bankName                  String?
  bankCode                  String?  // Paystack bank code
  accountNumber             String?
  accountName               String?  // Verified account name from Paystack
  
  // Paystack Subaccount (for split payments)
  paystackSubaccountCode    String?  @unique
  paystackSubaccountId      String?
  
  // Bank Verification
  bankVerified              Boolean  @default(false)
  bankVerificationMethod    String?  // API, PENNY_DROP
  bankVerifiedAt            DateTime?
  
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

model Property {
  id          String   @id @default(cuid())
  name        String
  address     String
  city        String
  country     String
  landlordId  String
  landlord    User     @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  units       Unit[]
  documents   Document[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Unit {
  id          String     @id @default(cuid())
  unitNumber  String
  propertyId  String
  property    Property   @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  bedrooms    Int        @default(1)
  bathrooms   Int        @default(1)
  rentAmount  Float
  status      String     @default("VACANT") // VACANT, OCCUPIED, RESERVED, UNDER_MAINTENANCE
  leases      Lease[]
  maintenance MaintenanceRequest[]
  documents   Document[]
  invitations TenantInvitation[]
  inspections Inspection[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Tenant {
  id              String            @id @default(cuid())
  userId          String            @unique
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  fullName        String
  phone           String
  idNumber        String?
  leases          Lease[]
  payments        Payment[]
  maintenance     MaintenanceRequest[]
  onlinePayments  OnlinePayment[]
  screening       TenantScreening?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
}

model TenantInvitation {
  id          String   @id @default(cuid())
  email       String
  fullName    String
  phone       String?
  unitId      String
  unit        Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  landlordId  String
  token       String   @unique @default(cuid())
  status      String   @default("PENDING") // PENDING, ACCEPTED, EXPIRED, CANCELLED
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Lease {
  id             String          @id @default(cuid())
  tenantId       String
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  unitId         String
  unit           Unit            @relation(fields: [unitId], references: [id], onDelete: Cascade)
  rentAmount     Float
  deposit        Float
  startDate      DateTime
  endDate        DateTime
  dueDay         Int             @default(1)
  status         String          @default("ACTIVE") // ACTIVE, ENDED, TERMINATED
  
  // Lease enhancements
  escalationRate    Float?       // Annual rent increase percentage
  escalationDate    DateTime?    // When escalation applies
  petsAllowed       Boolean      @default(false)
  parkingIncluded   Boolean      @default(false)
  specialClauses    String?      // JSON array of custom clauses
  noticePeriodDays  Int          @default(30)
  renewalStatus     String?      // PENDING, RENEWED, TERMINATED
  renewalNotifiedAt DateTime?
  
  // Relations
  rentCharges    RentCharge[]
  payments       Payment[]
  documents      Document[]
  onlinePayments OnlinePayment[]
  inspections    Inspection[]
  depositRecord  Deposit?
  utilities      UtilityBilling[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model RentCharge {
  id          String     @id @default(cuid())
  leaseId     String
  lease       Lease      @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  month       String     // Format: "2026-01"
  amountDue   Float
  amountPaid  Float      @default(0)
  status      String     @default("UNPAID") // PAID, PARTIAL, UNPAID, OVERDUE
  dueDate     DateTime
  allocations PaymentAllocation[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Payment {
  id          String              @id @default(cuid())
  tenantId    String
  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  leaseId     String
  lease       Lease               @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  amount      Float
  method      String              // CASH, BANK_TRANSFER, CARD, OTHER
  datePaid    DateTime
  reference   String?
  proofUrl    String?
  allocations PaymentAllocation[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
}

model PaymentAllocation {
  id           String     @id @default(cuid())
  paymentId    String
  payment      Payment    @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  rentChargeId String
  rentCharge   RentCharge @relation(fields: [rentChargeId], references: [id], onDelete: Cascade)
  amount       Float
  createdAt    DateTime   @default(now())
}

model MaintenanceRequest {
  id            String    @id @default(cuid())
  unitId        String
  unit          Unit      @relation(fields: [unitId], references: [id], onDelete: Cascade)
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  title         String
  description   String
  category      String   // PLUMBING, ELECTRICAL, HVAC, APPLIANCE, STRUCTURAL, OTHER
  priority      String   @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  status        String   @default("SUBMITTED") // SUBMITTED, IN_REVIEW, APPROVED, IN_PROGRESS, COMPLETED, REJECTED
  scheduledDate DateTime?
  attachments   String   @default("[]") // JSON array of URLs
  comments      Comment[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Comment {
  id                   String             @id @default(cuid())
  maintenanceRequestId String
  maintenanceRequest   MaintenanceRequest @relation(fields: [maintenanceRequestId], references: [id], onDelete: Cascade)
  authorId             String
  content              String
  createdAt            DateTime           @default(now())
}

model Document {
  id          String    @id @default(cuid())
  filename    String
  fileUrl     String
  docType     String    // LEASE_AGREEMENT, ID_PROOF, INSPECTION, RECEIPT, NOTICE, OTHER
  propertyId  String?
  property    Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  unitId      String?
  unit        Unit?     @relation(fields: [unitId], references: [id], onDelete: SetNull)
  leaseId     String?
  lease       Lease?    @relation(fields: [leaseId], references: [id], onDelete: SetNull)
  uploadedById String
  uploadedBy  User      @relation("UploadedBy", fields: [uploadedById], references: [id])
  createdAt   DateTime  @default(now())
}

model OnlinePayment {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  leaseId         String
  lease           Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  amount          Float
  reference       String   @unique // Paystack reference
  accessCode      String?  // Paystack access code for inline checkout
  authorizationUrl String? // Redirect URL
  status          String   @default("PENDING") // PENDING, SUCCESS, FAILED
  gatewayResponse String?  // JSON response from Paystack
  paidAt          DateTime?
  idempotencyKey  String?  @unique // Prevents duplicate payment initiation
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ========================
// Transaction Ledger (Central Financial Truth)
// ========================

model TransactionLedger {
  id              String   @id @default(cuid())
  tenantId        String
  landlordId      String
  propertyId      String
  leaseId         String
  paymentId       String?  // Link to Payment record
  onlinePaymentId String?  // Link to OnlinePayment record
  amount          Float
  platformFee     Float    @default(0)
  netAmount       Float    // amount - platformFee
  paymentMethod   String   // CARD, EFT, BANK_TRANSFER, CASH, ONLINE
  status          String   @default("PENDING") // PENDING, SUCCESS, FAILED, CANCELLED
  reference       String   @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ========================
// Payout Tracking
// ========================

model Payout {
  id            String    @id @default(cuid())
  landlordId    String
  amount        Float
  platformFee   Float     @default(0)
  netAmount     Float     // amount - platformFee
  status        String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  reference     String?   // Paystack transfer reference
  processedAt   DateTime?
  failureReason String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String   // USER_SIGNUP, USER_LOGIN, PAYMENT_RECEIVED, PROPERTY_CREATED, etc.
  entityType  String?  // User, Property, Payment, etc.
  entityId    String?
  details     String?  // JSON additional info
  ipAddress   String?
  createdAt   DateTime @default(now())
}

// ========================
// Phase 2: Inspection System
// ========================

model Inspection {
  id            String               @id @default(cuid())
  unitId        String
  unit          Unit                 @relation(fields: [unitId], references: [id], onDelete: Cascade)
  leaseId       String?
  lease         Lease?               @relation(fields: [leaseId], references: [id], onDelete: SetNull)
  type          String               // MOVE_IN, PERIODIC, MOVE_OUT
  scheduledDate DateTime
  completedAt   DateTime?
  status        String               @default("SCHEDULED") // SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED
  notes         String?
  items         InspectionItem[]
  signatures    InspectionSignature[]
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
}

model InspectionItem {
  id           String     @id @default(cuid())
  inspectionId String
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  room         String     // LIVING_ROOM, BEDROOM_1, KITCHEN, BATHROOM, etc.
  item         String     // WALLS, FLOORS, WINDOWS, DOORS, FIXTURES, etc.
  condition    String     // GOOD, FAIR, POOR, DAMAGED, N/A
  notes        String?
  photos       String     @default("[]") // JSON array of URLs
  createdAt    DateTime   @default(now())
}

model InspectionSignature {
  id           String     @id @default(cuid())
  inspectionId String
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  signedBy     String     // LANDLORD, TENANT
  signatureUrl String
  signedAt     DateTime   @default(now())
}

// ========================
// Phase 2: Deposit Management
// ========================

model Deposit {
  id              String             @id @default(cuid())
  leaseId         String             @unique
  lease           Lease              @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  amount          Float
  paidDate        DateTime?
  bankName        String?
  accountNumber   String?            // Interest-bearing account
  interestRate    Float              @default(0) // SA Prime Rate typically
  accruedInterest Float              @default(0)
  refundedAmount  Float?
  refundedAt      DateTime?
  status          String             @default("PENDING") // PENDING, HELD, REFUNDED, PARTIALLY_REFUNDED
  deductions      DepositDeduction[]
  disputes        DepositDispute[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

model DepositDeduction {
  id          String   @id @default(cuid())
  depositId   String
  deposit     Deposit  @relation(fields: [depositId], references: [id], onDelete: Cascade)
  reason      String   // PAINTING, REPAIRS, KEYS, CLEANING, DAMAGE, OTHER
  description String
  amount      Float
  evidence    String   @default("[]") // JSON array of photo/invoice URLs
  createdAt   DateTime @default(now())
}

model DepositDispute {
  id          String    @id @default(cuid())
  depositId   String
  deposit     Deposit   @relation(fields: [depositId], references: [id], onDelete: Cascade)
  deductionId String?
  reason      String
  status      String    @default("OPEN") // OPEN, RESOLVED_TENANT, RESOLVED_LANDLORD, WITHDRAWN
  response    String?
  createdAt   DateTime  @default(now())
  resolvedAt  DateTime?
}

// ========================
// Phase 2: Utilities Billing
// ========================

model UtilityBilling {
  id            String         @id @default(cuid())
  leaseId       String
  lease         Lease          @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  type          String         // ELECTRICITY, WATER, GAS, REFUSE, WIFI, OTHER
  billingMethod String         // PREPAID, METERED, FIXED
  fixedAmount   Float?         // For FIXED billing method
  ratePerUnit   Float?         // For METERED billing
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  readings      MeterReading[]
}

model MeterReading {
  id               String         @id @default(cuid())
  utilityBillingId String
  utilityBilling   UtilityBilling @relation(fields: [utilityBillingId], references: [id], onDelete: Cascade)
  month            String         // "2026-01"
  previousReading  Float
  currentReading   Float
  unitsUsed        Float
  totalCharge      Float
  photoProof       String?        // URL of meter photo
  notes            String?
  createdAt        DateTime       @default(now())
}

// ========================
// Phase 2: Notifications
// ========================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // RENT_DUE, RENT_OVERDUE, MAINTENANCE_UPDATE, LEASE_EXPIRY, INSPECTION_SCHEDULED, PAYMENT_RECEIVED
  title     String
  message   String
  isRead    Boolean  @default(false)
  actionUrl String?
  createdAt DateTime @default(now())
}

model NotificationPreference {
  id               String  @id @default(cuid())
  userId           String  @unique
  emailEnabled     Boolean @default(true)
  smsEnabled       Boolean @default(false)
  pushEnabled      Boolean @default(true)
  rentDueDays      Int     @default(3)  // Days before due date to remind
  rentOverdueDays  Int     @default(1)  // Days after due date to alert
  leaseExpiryDays  Int     @default(60) // Days before expiry to remind
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ========================
// Phase 2: Tenant Screening
// ========================

model TenantScreening {
  id                  String   @id @default(cuid())
  tenantId            String   @unique
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creditScore         Int?
  monthlyIncome       Float?
  affordabilityRatio  Float?   // Monthly income / rent amount
  previousLandlordRef String?  // Reference check notes
  employerRef         String?  // Employment verification notes
  idVerified          Boolean  @default(false)
  incomeVerified      Boolean  @default(false)
  riskScore           Int?     // 0-100 calculated score
  riskLevel           String?  // LOW, MEDIUM, HIGH
  notes               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}
